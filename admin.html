<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>管理画面</title>
    <link href="static/style.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div id="app" class="flex flex-col h-screen">

        <!-- Header -->
        <header class="bg-indigo-700 text-white p-4 shadow flex justify-between items-center">
            <h1 class="text-xl font-bold">和音当てクイズ 管理ダッシュボード</h1>
            <div class="flex gap-2">
                <input v-model="adminKey" type="password" placeholder="Admin Key"
                    class="px-3 py-1 rounded text-black text-sm w-32">
                <button @click="loadAllData"
                    class="bg-white text-indigo-700 px-4 py-1 rounded text-sm font-bold hover:bg-indigo-50">ロード</button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar: User List -->
            <div class="w-1/3 md:w-1/4 bg-white border-r overflow-y-auto">
                <div v-if="loading" class="p-4 text-center text-gray-500">ロード中...</div>
                <div v-else-if="users.length === 0" class="p-4 text-center text-gray-400">データなし</div>
                <div v-else class="divide-y">
                    <div v-for="user in users" :key="user.id" @click="selectUser(user)"
                        :class="{'bg-indigo-50 border-l-4 border-indigo-500': selectedUserId === user.id}"
                        class="p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="font-bold text-gray-800 truncate">{{ user.name }}</div>
                        <div class="text-xs text-gray-500 truncate">{{ user.id }}</div>
                        <div class="flex justify-between mt-2 text-xs">
                            <span class="bg-gray-200 px-2 py-0.5 rounded">{{ user.count }}回</span>
                            <span class="text-gray-400">{{ formatDate(user.lastActive) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main: Chart & Stats -->
            <div class="flex-1 p-6 overflow-y-auto bg-gray-50">
                <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    {{ error }}
                </div>

                <div v-if="!selectedUser" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <p class="text-xl">左のリストからユーザーを選択してください</p>
                    <p class="text-sm mt-2">（Admin Keyを入力してロードしてください）</p>
                </div>

                <div v-else class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span class="text-indigo-600">{{ selectedUser.name }}</span>
                            <span class="text-sm font-normal text-gray-500">({{ selectedUserId }})</span>
                        </h2>
                        <div class="h-80 relative">
                            <canvas id="adminChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-100 border-b">
                                <tr>
                                    <th class="px-4 py-3">日時</th>
                                    <th class="px-4 py-3">レベル</th>
                                    <th class="px-4 py-3">スコア</th>
                                    <th class="px-4 py-3">正答率</th>
                                    <th class="px-4 py-3">設定</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <tr v-for="item in selectedHistory" :key="item.timestamp" class="hover:bg-gray-50">
                                    <td class="px-4 py-2">{{ formatDate(item.timestamp) }}</td>
                                    <td class="px-4 py-2"><span class="font-bold">{{ item.level }}</span></td>
                                    <td class="px-4 py-2">{{ item.score }} / {{ item.total }}</td>
                                    <td class="px-4 py-2" :class="getRateColor(item.rate)">{{ item.rate }}%</td>
                                    <td class="px-4 py-2 text-gray-500">
                                        {{ item.settings?.instant ? '即時' : '後で' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, nextTick } = Vue;
        // Replace with actual API URL
        const API_ENDPOINT = 'https://cn3gzqh9ff.execute-api.ap-northeast-1.amazonaws.com/result';

        createApp({
            data() {
                return {
                    adminKey: '',
                    rawData: [],
                    users: [], // { id, name, count, lastActive, history: [] }
                    selectedUserId: null,
                    loading: false,
                    error: null,
                    chart: null
                }
            },
            computed: {
                selectedUser() {
                    return this.users.find(u => u.id === this.selectedUserId);
                },
                selectedHistory() {
                    if (!this.selectedUser) return [];
                    return this.selectedUser.history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }
            },
            methods: {
                async loadAllData() {
                    if (!this.adminKey) { this.error = "Admin Keyを入力してください"; return; }
                    this.loading = true;
                    this.error = null;
                    this.selectedUserId = null;

                    try {
                        const res = await fetch(`${API_ENDPOINT}?adminKey=${this.adminKey}`);
                        if (!res.ok) throw new Error("データの取得に失敗しました (Keyが間違っている可能性があります)");
                        const data = await res.json();

                        this.processData(data);
                    } catch (e) {
                        console.error(e);
                        this.error = e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                processData(data) {
                    // Group by userId
                    const userMap = {};

                    data.forEach(item => {
                        const uid = item.userId || 'unknown';
                        if (!userMap[uid]) {
                            userMap[uid] = {
                                id: uid,
                                name: item.name || 'No Name',
                                history: []
                            };
                        }
                        // Update name to latest if available
                        if (item.name && new Date(item.timestamp) > new Date(userMap[uid].lastActive || 0)) {
                            userMap[uid].name = item.name;
                        }
                        userMap[uid].history.push(item);
                    });

                    // Convert to array and summarize
                    this.users = Object.values(userMap).map(u => {
                        u.lastActive = u.history.reduce((max, cur) => {
                            const t = new Date(cur.timestamp);
                            return t > max ? t : max;
                        }, new Date(0));
                        u.count = u.history.length;
                        return u;
                    }).sort((a, b) => b.lastActive - a.lastActive); // Sort users by recent activity
                },

                selectUser(user) {
                    this.selectedUserId = user.id;
                    nextTick(() => {
                        this.renderChart(user.history);
                    });
                },

                formatDate(iso) {
                    if (!iso) return '-';
                    const d = new Date(iso);
                    return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                },

                getRateColor(rate) {
                    if (rate >= 80) return 'text-green-600 font-bold';
                    if (rate < 40) return 'text-red-500';
                    return 'text-gray-700';
                },

                renderChart(history) {
                    const ctx = document.getElementById('adminChart');
                    if (!ctx) return;

                    if (this.chart) this.chart.destroy();

                    const sorted = history.slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    const levels = [...new Set(sorted.map(d => d.level))].sort((a, b) => a - b);
                    const datasets = levels.map((lvl, index) => {
                        const lvlData = sorted.filter(d => d.level === lvl);
                        const color = this.getColor(index);
                        return {
                            label: `Lv ${lvl}`,
                            data: lvlData.map(d => ({ x: d.timestamp, y: d.score })), // Simply match label index
                            borderColor: color,
                            backgroundColor: color,
                            tension: 0.3,
                            pointRadius: 4
                        };
                    });

                    // Map timestamps to labels
                    // Simplification: We map simply by index sequence for now or use timestamp labels
                    const labels = sorted.map(d => this.formatDate(d.timestamp));

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets.map(ds => ({
                                ...ds,
                                data: sorted.map(d => (d.level === parseInt(ds.label.split(' ')[1])) ? d.score : null),
                                spanGaps: true
                            }))
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 10 },
                                x: { display: false } // Hide X labels if too crowded
                            },
                            plugins: {
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            }
                        }
                    });
                },
                getColor(i) {
                    const colors = ['#f87171', '#fb923c', '#facc15', '#4ade80', '#60a5fa', '#a78bfa', '#e879f9'];
                    return colors[i % colors.length];
                }
            }
        }).mount('#app');
    </script>
</body>

</html>