# 002: うなり消しゲーム（仮） 要件定義書

## 1. ゲームコンセプト
「うなり（干渉）」が消える正確なポイントを見つけ出すことで、音に対する鋭敏な感覚を養う耳トレーニングゲーム。

## 2. ゲームプレイの流れ
1.  **レベル選択**: 
    - ゲーム開始時に、以下の3つのスタート地点から選択できる。
        - **レベル 1**: ここからはじめる（かんたん）
        - **レベル 15**: なれてきたら（ふつう）
        - **レベル 30**: ちょうせん！（むずかしい）
2.  **レベル開始前（出題ポップアップ）**: 
    - 各問題の開始前に、2秒間オーバーレイで以下の情報を表示する。
        - クイズレベル
        - 和音（音程名 - 日本語・ひらがな）
        - 音の種類（楽器名 - 日本語・ひらがな・絵文字付き）
        - 許容音幅（難易度に関わる指標）
    - ポップアップには「ワクワク感」を演出するアニメーションを付与する。
3.  **自動再生**: ポップアップが消えると同時に、2つの音が自動的に鳴り始める。
4.  **操作**: スライダーを動かし、きれいなハーモニーをさがす（うなりが消失するポイントを探す）。
    - 演奏中、音量をいつでも変更できるようにボリュームコントロールを提供する。
    - 「音を止める」ボタンは廃止し、常に音が鳴り続ける仕様とする。
5.  **視覚的補助**:
    - 通常時は、音のズレ（うなり）の大きさに応じて画面上のキャラクターが振動する。
    - **難易度上昇による減衰**: レベル1からだんだん振動の量を減らしていき、レベル31（許容音幅が10セント以下の領域）で完全に振動しなくなる（視覚補助OFF）。
6.  **回答**: 「これだ！」ボタンを押して回答を確定する。
7.  **判定（判定ポップアップ）**:
    - 回答後、正解または不正解をアニメーション付きのポップアップで表示する。
    - 判定表示後は自動で遷移せず、ユーザーが「つぎへ！」ボタンを押すことで次の問題（またはリザルト）へ進む。
    - **正解**: 許容音幅内であれば正解。スコアが加算され、次のレベルに進む。
    - **不正解**: 範囲外であれば不正解。ライフが1減少する。
8.  **ゲームオーバー**: ライフが0になるとゲーム終了。
9.  **リザルト**: ゲーム終了後、AWSへスコアを登録し、過去の推移をグラフで表示する。

## 3. 難易度設計とパラメータ
各レベルの問題は、以下のパラメータによって構成される。これらの具体的な値は外部のJSONファイルによって定義・管理される。

-   **レベルデザイン**: `level_design.json` に、各レベルで使用する音色、音程、ダイナミクス等を定義する。
    -   Lv1〜: ノコギリ波 (Sawtooth Wave) ※音量は振幅比0.25倍
    -   Lv6〜: フルート (Flute)
    -   Lv10〜: バイオリン (Violin)
    -   Lv15〜: クラリネット (Clarinet)
    -   Lv20〜: チェロ (Cello)
    -   Lv25〜: ファゴット (Bassoon)
    -   Lv30〜: 全楽器からランダム選択
-   **基音**: `instrument_notes.json` に、各楽器（音色）で使用可能な基音のリストを定義する。問題生成時、このリストからランダムに基音が選択される。
-   **基準音のゆらぎ**: **Lv50以降**は、基準となる音の周波数が本来のピッチから最大±50セント（1/4音）ランダムに変化し、相対音感が試される。

### 3.1. 主要パラメータ
-   **音幅（インターバル）**: 基点となる音（固定音）と操作音の周波数関係。**純正律 (Just Intonation)** の周波数比を採用する。
-   **音色（Timbre）**:
    -   基本: サイン波 (Sine Wave), 鋸歯状波 (Sawtooth Wave)
    -   サンプリング音源: バイオリン (Violin), ヴィオラ (Viola), チェロ (Cello), コントラバス (Contrabass), ピッコロ (Piccolo), フルート (Flute), オーボエ (Oboe), ファゴット (Bassoon), ホルン (Horn), トランペット (Trumpet), トロンボーン (Trombone), チューバ (Tuba), サックス (Saxophone), クラリネット (Clarinet)
-   **ダイナミクス（音量変化）**: 音量の時間的変化。
-   **正解の許容音幅（Tolerance）**: 正解と判定されるピッチの範囲。
    -   初期値: 20セント
    -   **レベル上昇による変化**: レベルが5上がるごとに1セントずつ狭くなる（最小値3セント）。

## 4. 判定・スコアリング
-   **スコア**: 1問正解するごとに100点を加算。
-   **ライフ**: 初期値は3。不正解で1減少。

## 5. 技術要件
-   **音声合成**: Web Audio APIを使用。基本波形はOscillator、楽器音はAudioBufferSourceNodeを使用。
-   **マスターボリューム**: ゲーム全体、または演奏中の音量を制御するゲインノードの実装。
-   **UI/UX**: Tailwind CSSとアニメーションを使用した動的なポップアップ演出。
-   **データ連携**: AWS API Gateway / Lambda を介してスコア保存・取得。
-   **グラフ表示**: Chart.js 等を使用した統計表示。
