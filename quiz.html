<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="static/style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="static/site.js"></script>
  <title>クイズ</title>
</head>

<body class="bg-slate-50 min-h-screen flex items-center justify-center">
  <div id="app" class="w-full max-w-3xl p-6">
    <div class="bg-white rounded-xl shadow p-6 relative">
      <div id="questionCounter" class="absolute top-4 right-6 text-gray-500 font-bold text-lg"></div>
      <h1 id="status" class="text-xl font-bold text-center mb-8 mt-2 min-h-[1.5em]">おとをきいてね！</h1>

      <div id="buttons" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4 opacity-0 transition-opacity duration-700">
      </div>

      <div class="flex justify-center gap-4 mt-4">
        <button id="nextBtn" class="opacity-50 px-6 py-3 rounded-lg bg-green-500 text-white font-bold"
          disabled>これでけってい</button>
        <button id="replayBtn" class="px-6 py-3 rounded-lg bg-gray-200">もういちどきく</button>
      </div>

      <audio id="audio"></audio>
    </div>
  </div>

  <script>
    let quiz = [];
    let index = 0;
    let instant = true; // 即時採点ON/OFF
    const audio = document.getElementById('audio');
    let answers = [];
    let answered = false;
    let currentSelection = null;
    let currentLevel = 1;

    // Reset history on load to prevent accumulation
    localStorage.removeItem('lastAnswers');

    const colorMap = Site.colorMap;
    const noteMap = Site.noteMap;

    async function loadQuiz(level) {
      currentLevel = level;
      quiz = await Site.generateQuiz(level, Site.QUESTION_COUNT);
      answers = [];
      const sounds = await Site.getSoundsForLevel(level);
      renderChoiceButtons(sounds || [], level);
      playQuestion();
    }

    function playQuestion() {
      if (index >= quiz.length) {
        localStorage.setItem('lastAnswers', JSON.stringify(answers));
        const score = answers.filter(a => a.correct).length;
        localStorage.setItem('score', String(score));
        window.location.href = "result.html";
        return;
      }
      const note = quiz[index];
      audio.src = `static/sounds/${note}`;
      audio.pause();
      audio.currentTime = 0;
      document.getElementById('buttons').classList.add('opacity-0');
      document.getElementById('nextBtn').disabled = true;
      document.getElementById('status').textContent = `さいせいちゅう...`;
      document.getElementById('questionCounter').textContent = `${index + 1} / ${Site.QUESTION_COUNT}`;

      // Reset button styles
      Array.from(document.getElementById('buttons').querySelectorAll('button')).forEach(b => {
        b.style.boxShadow = 'none';
        b.classList.remove('bg-green-200', 'bg-red-200'); // Remove old classes if any remained
      });

      audio.play().then(() => {
        setTimeout(() => {
          document.getElementById('buttons').classList.remove('opacity-0');
          document.getElementById('status').textContent = `おとをきいたらボタンをおしてね`;
          answered = false;
          setChoiceButtonsDisabled(false);
        }, 2000);
      }).catch(e => console.log(e));
    }

    function renderChoiceButtons(sounds, level) {
      const container = document.getElementById('buttons');
      container.innerHTML = '';
      const colors = sounds.map(f => {
        const parts = f.split('_');
        return parts.length > 1 ? parts[1].split('.')[0] : f;
      });
      // map color -> representative filename (first occurrence)
      const colorToFile = {};
      sounds.forEach(f => { const parts = f.split('_'); const raw = parts.length > 1 ? parts[1].split('.')[0] : f; if (!colorToFile[raw]) colorToFile[raw] = f; });
      // allow number of choices equal to number of sound files for the level
      const unique = Array.from(new Set(colors)).slice(0, Math.max(6, sounds.length));
      unique.forEach((raw) => {
        // Find representative file for this color
        const soundFile = colorToFile[raw];
        if (!soundFile) return;

        const btn = Site.createChordButton(soundFile, {
          disabled: true,
          onPointerDown: (e) => {
            e.preventDefault(); e.stopPropagation();
            if (instant) {
              if (!btn.disabled) { btn.disabled = true; btn.style.opacity = '0.6'; }
              answer(raw);
            } else {
              currentSelection = raw;
              Array.from(container.querySelectorAll('button')).forEach(b => {
                b.style.outline = (b.dataset.label === raw) ? '3px solid rgba(0,0,0,0.4)' : 'none';
              });
              document.getElementById('status').textContent = `あなたの　えらんだおと: ${Site.colorMap[raw] || raw}`;
              document.getElementById('nextBtn').disabled = false;
              document.getElementById('nextBtn').classList.remove('opacity-50');
            }
          }
        });

        container.appendChild(btn);
      });
    }

    function answer(ans) {
      if (answered) return;
      answered = true;
      setChoiceButtonsDisabled(true);
      const file = quiz[index];
      const correct = file.toLowerCase().includes(ans.toLowerCase());
      answers.push({ choice: ans, correct: correct, file: file });
      const statusEl = document.getElementById('status');

      // Highlighting logic
      const container = document.getElementById('buttons');
      Array.from(container.querySelectorAll('button')).forEach(b => {
        // Remove existing outlines
        b.style.outline = 'none';

        const bRaw = b.dataset.label;
        const bIsCorrect = file.toLowerCase().includes(bRaw);
        const bIsSelected = (bRaw === ans);

        if (bIsCorrect) {
          // Correct answer: Green shadow
          b.style.boxShadow = '0 0 15px 5px rgba(74, 222, 128, 0.9)'; // Green-400
          b.style.opacity = '1';
        }
        if (!correct && bIsSelected) {
          // Wrong selection: Red shadow
          b.style.boxShadow = '0 0 15px 5px rgba(248, 113, 113, 0.9)'; // Red-400
          b.style.opacity = '1';
        }
      });

      if (instant) {
        if (correct) {
          statusEl.textContent = 'やったね！せいかい！';
          try { new Audio('static/sounds/correct.mp3').play(); } catch (e) { }
        } else {
          const raw = file.split('_')[1] ? file.split('_')[1].split('.')[0] : file;
          const label = (Site.colorMap[raw]) || raw;
          statusEl.textContent = `ちがうよ。こたえは ${label} だよ`;
          try { new Audio('static/sounds/wrong.mp3').play(); } catch (e) { }
        }
        // Auto advance
        setTimeout(() => {
          index++;
          playQuestion();
        }, 1500);
      } else {
        statusEl.textContent = `あなたの　えらんだおと: ${(colorMap[ans] || ans)}`;
        // No auto-advance in normal mode
        document.getElementById('nextBtn').textContent = 'これでけってい'; // Ensure text is correct if logic changes
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').classList.remove('opacity-50');
      }
    }

    function setChoiceButtonsDisabled(disabled) {
      const container = document.getElementById('buttons');
      Array.from(container.querySelectorAll('button')).forEach(b => {
        b.disabled = disabled;
        b.style.opacity = disabled ? '0.6' : '1';
      });
    }

    document.getElementById('nextBtn').addEventListener('pointerdown', (e) => {
      e.preventDefault();
      if (!instant) {
        const file = quiz[index];
        const choice = currentSelection || '';
        const correct = file.toLowerCase().includes(choice.toLowerCase());
        answers.push({ choice: choice, correct: correct, file: file });
        currentSelection = null;
        Array.from(document.getElementById('buttons').querySelectorAll('button')).forEach(b => { b.style.outline = 'none'; });
      }
      index++;
      playQuestion();
    });

    document.getElementById('replayBtn').addEventListener('pointerdown', (e) => {
      e.preventDefault();
      audio.pause();
      audio.currentTime = 0;
      audio.play();
    });

    const storedLevel = Number(localStorage.getItem('selectedLevel') || 1);
    const storedInstant = localStorage.getItem('instant');
    if (storedInstant === '1') instant = true;
    else if (storedInstant === '0') instant = false;

    if (instant) {
      document.getElementById('nextBtn').style.display = 'none';
    }

    loadQuiz(storedLevel);
  </script>
</body>

</html>