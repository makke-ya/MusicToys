<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>和音確認</title>
  <link href="static/style.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="static/site.js"></script>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center">
  <div id="app" class="w-full max-w-3xl p-6">
    <div class="bg-white rounded-xl shadow p-6 relative">
      <div id="fileCount" class="absolute top-4 right-6 text-gray-500 font-bold text-lg"></div>
      <h1 class="text-xl font-bold mb-4">わおん の かくにん</h1>
      <p id="info" class="text-sm text-gray-600 mb-4"></p>

      <div id="chords" class="grid grid-cols-4 gap-6 mb-4"></div>

      <div class="flex gap-3">
        <button id="startQuizBtn" class="btn-action px-6 py-3 bg-indigo-600 text-white rounded">スタート</button>
        <a href="level_select.html"
          class="btn-action px-6 py-3 inline-block border rounded text-center bg-white">もどる</a>
      </div>
    </div>
  </div>

  <script>
    (async function () {
      try {
        if (typeof Site === 'undefined') {
          throw new Error('Site object is not loaded. Check site.js');
        }
        const level = Number(localStorage.getItem('selectedLevel') || 1);
        const instant = localStorage.getItem('instant') === '1';
        document.getElementById('info').textContent = `れべる ${level} — ${instant ? 'すぐにこたえをみる' : 'あとでこたえをみる'}`;
        document.getElementById('fileCount').textContent = `ぜんぶで ${Site.QUESTION_COUNT || 10} もん`;

        const colorMap = Site.colorMap;
        const noteMap = Site.noteMap;

        const previewAudio = new Audio();
        let playingBtn = null;

        const sounds = await Site.getSoundsForLevel(level);
        const container = document.getElementById('chords');
        if (!sounds.length) { container.textContent = '音ファイルがありません'; return; }

        sounds.forEach((fname) => {
          const btn = Site.createChordButton(fname, {
            extraClasses: 'btn-large focus:outline-none',
            labelClass: 'text-xl font-bold',
            onClick: () => {
              if (!previewAudio.paused) { previewAudio.pause(); previewAudio.currentTime = 0; }
              if (playingBtn && playingBtn !== btn) { playingBtn.style.boxShadow = 'none'; }
              previewAudio.src = `static/sounds/${fname}`;
              previewAudio.play().catch(() => { });
              playingBtn = btn;
              btn.style.boxShadow = '0 0 12px rgba(0,0,0,0.18)';
              previewAudio.onended = () => { if (playingBtn) { playingBtn.style.boxShadow = 'none'; playingBtn = null; } };
            }
          });
          container.appendChild(btn);
        });

        document.getElementById('startQuizBtn').addEventListener('click', () => {
          localStorage.setItem('instant', instant ? '1' : '0');
          window.location.href = 'quiz.html';
        });
      } catch (e) {
        console.error(e);
        document.getElementById('chords').innerHTML = `<div class="col-span-4 text-red-500 font-bold">エラーが発生しました: ${e.message}</div>`;
      }
    })();
  </script>
</body>

</html>